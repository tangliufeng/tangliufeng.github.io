---
layout: post
title: "L2CAP(逻辑链路控制及自适应协议层)"
subtitle: ""
date: 2020-10-08
author: "tangliufeng"
header-img: "img/post-bg-2015.jpg"
tags: 
    - BLE
---


# 1. L2CAP (逻辑链路控制及自适应协议层)

逻辑链路控制及自适应协议层（Logical Link Control and Adaptation Protocol，简写 L2CAP）：L2CAP对LL进行了一次简单封装，LL只关心传输的数据本身，L2CAP就要区分是加密通道还是普通通道，同时还要对连接间隔进行管理。

## 1.1. 空口包

连接态的数据包我们统称为  Data Channel PDU ，与  Advertising Channel PDU 不同，Data Channel PDU 允许数据在除了 37、38、39信道上的其他的 37 个信道上进行数据传输，根据用途，又将其分为两种：

- LL Data PDU：纯数据包
- LL Control PDU：控制包

普通数据包格式如下：

![](https://upload-images.jianshu.io/upload_images/2959133-e622712e22876880.png?imageMogr2/auto-orient/strip|imageView2/2/w/687/format/webp)

![](https://www.pianshen.com/images/529/85b5ebe4d37667ea1f9c28f3b9fb5d89.png)

Data header，即前述的LL header，在数据包中的定义如下所示：

![](https://upload-images.jianshu.io/upload_images/2959133-a63385dcf2f11835.png?imageMogr2/auto-orient/strip|imageView2/2/w/689/format/webp)

- LLID ： 用于区分这个 Connection 的包是普通的数据包（L2CAP 的起始/连续/空包），还是 Control PDU

  - 00b = Reserved 
  - 01b = LL Data PDU: Continuation fragment of an L2CAP message, or an Empty PDU.
  - 10b = LL Data PDU: Start of an L2CAP message or a complete L2CAP message with no fragmentation.
  - 11b = LL Control PDU

- NESN：下一个期望的对端包的 Sequence Number
- SN：当前包的 Sequence Number
- MD：是否有 More Data
- RFU：预留
- Length：Playload （含 MIC） 的数据长度，单位是字节
  

## 1.2. LL Control PDU

控制 PDU （也成为 LLCP）主要用于建立连接后的一些参数设置，流程交互等等：

![](https://www.pianshen.com/images/663/79b86f37d7de1e2370fc3dc73bcdbd67.png)


不同的 Opcode 代表了不同的控制包：

| Opcode           | Control PDU Name         | Description              |
| ---------------- | ------------------------ | ------------------------ |
| 0x00             | LL_CONNECTION_UPDATE_IND | 更新链接参数             |
| 0x01             | LL_CHANNEL_MAP_IND       | 更新链接的 Channel Map   |
| 0x02             | LL_TERMINATE_IND         | 断开连接请求             |
| 0x03             | LL_ENC_REQ               | 加密流程相关交互         |
| 0x04             | LL_ENC_RSP               |                          |
| 0x05             | LL_START_ENC_REQ         |                          |
| 0x06             | LL_START_ENC_RSP         |                          |
| 0x07             | LL_UNKNOWN_RSP           | 收到未知的 LLCP 后的回复 |
| 0x08             | LL_FEATURE_REQ           | 请求交换 Feature 的交互  |
| 0x09             | LL_FEATURE_RSP           |                          |
| 0x0A             | LL_PAUSE_ENC_REQ         | 重启加密流程相关交互     |
| 0x0B             | LL_PAUSE_ENC_RSP         |                          |
| 0x0C             | LL_VERSION_IND           | 交互 Version             |
| 0x0D             | LL_REJECT_IND	拒绝请求   |
| 0x0E             | LL_SLAVE_FEATURE_REQ     | Slave 请求 Feature       |
| 0x0F             | LL_CONNECTION_PARAM_REQ  | 更新链接参数             |
| 0x10             | LL_CONNECTION_PARAM_RSP  |
| 0x11             | LL_REJECT_EXT_IND        | 扩展类型的拒绝请求       |
| 0x12             | LL_PING_REQ              | 加密后的 PING 流程交互   |
| 0x13             | LL_PING_RSP              |
| 0x14             | LL_LENGTH_REQ            | 更新空口数据长度         |
| 0x15             | LL_LENGTH_RSP            |
| 0x16             | LL_PHY_REQ               | PHY更新相关交互          |
| 0x17             | LL_PHY_RSP               |
| 0x18             | LL_PHY_UPDATE_IND        |
| 0x19             | LL_MIN_USED_CHANNELS_IND | Channels 相关的配置      |
| All other values | Reserved for Future Use  | 预留                     |




